{% extends 'core/base.html' %}

{% block content %}
<div class="flex flex-col justify-between items-center w-full">
    <div class="flex items-end bg-white border-2 rounded-lg h-3/5 w-3/5 shadow-2xl p-1">
        <div id="chart" class="h-full w-full"></div> <!-- GrÃ¡fico de linhas -->
    </div>
    <div class="bg-sky-200 px-10 py-4 rounded-xl border border-2 border-sky-800 h-auto w-3/4 shadow-lg">
        <div class="grid grid-cols-4 w-full font-semibold text-sky-800">
            <div class="flex flex-col gap-1">
                Base
                <select id="baseCurrency" class="border border-sky-800 rounded-md p-1 w-4/5">
                    <option value="USD">USD - US Dollar</option>
                    <option disabled="true" value="BRL">BRL - Brazilian Real</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                    <option value="JPY">JPY - Japanese Yen</option>
                    <option value="CHF">CHF - Swiss Franc</option>
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="AUD">AUD - Australian Dollar</option>
                </select>
            </div>
            <div class="flex flex-col gap-1">
                Target
                <select id="targetCurrency" class="border border-sky-800 rounded-md p-1 w-4/5">
                    <option disabled="true" value="USD">USD - US Dollar</option>
                    <option selected value="BRL">BRL - Brazilian Real</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                    <option value="JPY">JPY - Japanese Yen</option>
                    <option value="CHF">CHF - Swiss Franc</option>
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="AUD">AUD - Australian Dollar</option>
                </select>
            </div>
            <div class="flex flex-col gap-1 col-span-2 ml-32">
                Period
                <div class="flex gap-3">
                    <input type="date" id="startDate" class="border border-sky-800 rounded-md p-1" 
                            value="{{ one_year_ago|date:'Y-m-d' }}"
                            max="{{ current_date|date:'Y-m-d' }}">
                    <input type="date" id="endDate" class="border border-sky-800 rounded-md p-1"
                            value="{{ current_date|date:'Y-m-d' }}"
                            max="{{ current_date|date:'Y-m-d' }}">
                </div>
            </div>
            <div class="flex justify-center mr-10">
                <img id="baseCurrencyFlag" src="https://www.countryflagicons.com/FLAT/64/US.png">
            </div>
            <div class="flex justify-center mr-10">
                <img id="targetCurrencyFlag" src="https://www.countryflagicons.com/FLAT/64/BR.png">
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    function updateFlagImages(baseCurrency, targetCurrency) {
        const baseCurrencyFlag = document.getElementById('baseCurrencyFlag');
        const targetCurrencyFlag = document.getElementById('targetCurrencyFlag');

        baseFlag = baseCurrency.slice(0, -1);
        targetFlag = targetCurrency.slice(0, -1);

        // Replace the 'XX' in the URL with the currency codes to fetch the correct flag images
        baseCurrencyFlag.src = `https://www.countryflagicons.com/FLAT/64/${baseFlag}.png`;
        targetCurrencyFlag.src = `https://www.countryflagicons.com/FLAT/64/${targetFlag}.png`;
    }

    function generateChart() {
        const baseCurrency = document.getElementById('baseCurrency').value;
        const targetCurrency = document.getElementById('targetCurrency').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const parts = endDate.split('-')
        const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;

        if (baseCurrency === targetCurrency) {
            alert('Please select different base and target currencies.');
            return;
        }

        if (startDate >= endDate) {
            alert('Please select a valid date range.');
            return;
        }

        const apiUrl = `https://api.frankfurter.app/${startDate}..${endDate}?from=${baseCurrency}&to=${targetCurrency}`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Data received from API:', data);

                const dates = Object.keys(data.rates);
                const rates = dates.map(date => data.rates[date][targetCurrency]);

                console.log('Dates:', dates);
                console.log('Rates:', rates);

                const trace = {
                    x: dates,
                    y: rates,
                    type: 'line',
                    line: {
                        color: 'rgb(7, 89, 133)',
                        width: 2,
                    },
                };

                const layout = {
                    title: `${baseCurrency} to ${targetCurrency} Chart`,
                    titlefont: {
                        color: 'rgb(7, 89, 133)',
                        size: 24,
                        weight: 'bold', 
                    },
                    yaxis: {
                        title: {
                            text: 'Exchange Rate',
                            standoff: 15,
                            standangle: 30,
                            font: {
                                color: 'rgb(7, 89, 133)',
                                size: 14,
                            },
                        },
                        fixedrange: true,
                    },
                    xaxis: {
                        fixedrange: true,
                    },
                    staticPlot: true,
                    annotations: [
                        {
                            x: 1,
                            y: 1.3,
                            xref: 'paper', 
                            yref: 'paper', 
                            text: `1 ${baseCurrency} = ${rates[rates.length - 1]} ${targetCurrency} | ${formattedDate}`, 
                            showarrow: false, 
                        },
                    ],
                };
                const config = {
                    modeBarButtonsToRemove: [
                        'zoom',
                        'zoom2d',
                        'pan2d',
                        'zoomIn2d',
                        'zoomOut2d',
                        'autoScale2d',
                        'resetScale2d',
                        'hoverCompareCartesian',
                        'hoverClosestCartesian',
                        'toggleSpikelines',
                        'resetViews',
                        'toggleHover',
                    ],
                    displaylogo: false,
                    responsive: true,
                    toImageButtonOptions: {
                        format: 'png',
                        filename: `${startDate}..${endDate}_${baseCurrency}_to_${targetCurrency}_chart`,
                    },
                    editable: false,
                };

                Plotly.newPlot('chart', [trace], layout, config);
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    // Call the function when the page is ready
    document.addEventListener('DOMContentLoaded', generateChart);

    document.getElementById('startDate').addEventListener('change', generateChart);
    document.getElementById('endDate').addEventListener('change', generateChart);

    // Update the targetCurrency options based on baseCurrency selection
    document.getElementById('baseCurrency').addEventListener('change', function () {
        const baseCurrency = this.value;
        const targetCurrencySelect = document.getElementById('targetCurrency');
        const targetCurrencyOptions = targetCurrencySelect.querySelectorAll('option');

        // Enable all targetCurrency options first
        targetCurrencyOptions.forEach(option => option.disabled = false);

        // Disable the selected baseCurrency option in targetCurrency dropdown
        for (let option of targetCurrencyOptions) {
            if (option.value === baseCurrency) {
                option.disabled = true;
                break;
            }
        }

        // Update the flag images
        const targetCurrency = targetCurrencySelect.value;
        updateFlagImages(baseCurrency, targetCurrency);
        generateChart();
    });

    // Update the baseCurrency options based on targetCurrency selection
    document.getElementById('targetCurrency').addEventListener('change', function () {
        const targetCurrency = this.value;
        const baseCurrencySelect = document.getElementById('baseCurrency');
        const baseCurrencyOptions = baseCurrencySelect.querySelectorAll('option');

        // Enable all baseCurrency options first
        baseCurrencyOptions.forEach(option => option.disabled = false);

        // Disable the selected targetCurrency option in baseCurrency dropdown
        for (let option of baseCurrencyOptions) {
            if (option.value === targetCurrency) {
                option.disabled = true;
                break;
            }
        }

        // Update the flag images
        const baseCurrency = baseCurrencySelect.value;
        updateFlagImages(baseCurrency, targetCurrency);
        generateChart();
    });
</script>
{% endblock %}